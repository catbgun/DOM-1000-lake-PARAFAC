---
title: '1000Lakes: UV-Vis abs'
author: "CBG"
date: "6 1 2022"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

# An Exploration of UV-Vis data - "1000 Lakes Study"
All samples from the 1000-lakes survey were analysed for UV-Vis absorbance. Here, corrections are made (dilution, other corrections), LOQ determined from blanks, indices, slope ratios etc. calculated, and explored. 

```{r load required packages, include=FALSE}
Packages <- c("ggplot2", "dplyr", "data.table", "tidyr")
#"libwgeom",
lapply(Packages, library, character.only = TRUE)
```

### The following datasets will be required
- UV-Vis absorbance data 
- chemistry + catchment data
- sample ID conversion file for the file above
```{r load required data and merge the two, keep all samples}
#blank-corrected data from Rolf, all data, no dilution correction
rdv <- read.table("RDV_UVVis_BlankCorrected5.txt", sep = "\t", header = TRUE)
names(rdv) <- gsub(x = names(rdv), pattern = "X", replacement = "DOM")  

#use ra data to find samples with signal at 254 nm < LOQ
#LOQ at 254nm calculated to 0.016
abs <- read.table("A1000Lakes_all_trans.txt", sep = "\t", header = TRUE)
threshhold <- 0.016  
abst <- subset(abs, abs[, 809] > threshhold)  
toolow <- subset(abs, abs[, 809] < threshhold) 
nrow(toolow)
nrow(abst)

#other datasets needed
chemcatch <- read.table("1000 lakes joint 29102021_3.txt", sep = "\t", header = TRUE)
d1 <- read.table("1000 sjøer station id og kode.csv", sep = ";", header = TRUE)
d1$station_id = d1$ï..Station.ID
#abs <- read.table("A1000Lakes_all_trans.txt", sep = "\t", header = TRUE)
SNames <- fread("Provenavn.txt", sep = "\t", header = TRUE, select=c("Prøvenr", "Stasjonskode"))
SNames$Station.Code.x = SNames$Stasjonskode
SNames$sample = SNames$Prøvenr
```
### Corrections that must be made includes
- UV-Vis correction
- column names adjusted for merging
- Mean Absorption values from 700 to 900nm are subtracted from the entire spectrum for each sample to
account for absorption offset (Helms et al., 2008)
-  multiplied by 2 following dilution? DOM12522, DOM13465, DOM13010, DOM13474 + more
```{r UV-Vis correction step, subtracting the mean}
#Seems like this also needs to be done on raw data or else we get negative values?
rdv2 <- t(rdv)
colnames(rdv2) <- rdv2[1,]
rdv2 <- rdv2[-1, ]
colnames(rdv2) <- paste("X", colnames(rdv2),sep = "_")
class(rdv3)
rdv3 <- as.data.frame(rdv2)
rdv2$corr = rowMeans(subset(rdv2, select = c(X_700:X_900)))

absC <- sweep(rdv2[,c(2:1056)], 1, rdv2$corr, "-")
absC$wavelength = rdv$wavelength



rdv$corr = rowMeans(subset(rdv, select = c(626:876)))
absC <- sweep(rdv2[,c(2:1056)], 1, rdv2$corr, "-")
absC$wavelength = rdv$wavelength

#write.table(absC, file = "1000Lakes_UVVis_corrected.txt", sep = "\t",
          #  row.names = FALSE)

#absS <- absC[-grep("DOMB", absC$sample), ]
#absS2 <- absS[-grep("DOMSTD", absS$sample), ]
#nrow(absS2)
#my_data <- absC %>% 
#  filter(sample %in% c("DOM12522", "DOM13465", "DOM13010", "DOM13474"))

SNames$Station.Code.x = SNames$Stasjonskode
SNames$sample = SNames$Prøvenr

```
### Have a look at the spectra and see if possible to smooth
- can this be done for all of the samples or only those with DOC too low
- go from wide to long format for plotting
- smoothing: http://r-statistics.co/Loess-Regression-With-R.html
```{r Viasulise and smooth spectra}
#data_long <- gather(absC, sample, value, DOM11594:DOM12686)
data_long2 <- gather(rdv, sample, value, DOM11594:DOM12685)

#data_long <- gather(b3, wavelength, value, X604:wavelength)
#data_long2$wavelength<-gsub("X","",data_long2$wavelength)
data_long2$wavelength <- as.numeric(data_long2$wavelength)


loessD <- data_long2 %>%
  group_by(sample) %>%
  mutate(model = loess(value ~ wavelength, span = 0.3)$fitted)




#data_long$DOC <- as.factor(ifelse(data_long$X2019_DOC.C<1, 'very low',
  #                           ifelse(data_long$X2019_DOC.C<5, 'low',
  #                          ifelse(data_long$X2019_DOC.C<10, 'medium',
  #                         ifelse(data_long$X2019_DOC.C<20, 'high', 'very high')))))
#[which(data_long$X2019_DOC.C<5),]

#ggplot(aes(x=wavelength, y=value, group=sample), data=data_long)+
#  geom_line(size=1, data_long=subset(data_long,DOC="very low"))
#facet_wrap(data_long$DOC)
#  geom_line(color="red")
  
ggplot(aes(x=wavelength, y=value, group=sample), data=loessD)+
  geom_line(size=1)
 
  ggplot(aes(x=wavelength, y=value, group=sample), data=data_long2)+
  geom_line(size=1)
  facet_wrap(data_long$DOC)
  geom_line(color="red")

spec = as_spectra(absC, name_idx = 1)
spec = smooth(spec, parallel = FALSE)
#   

#select a few samples to look at smoothing
dfs <- data_long[data_long$sample == "DOM11384", ]
dfs <- data_long[data_long$sample == "DOM11379", ] #high abs
dfs <- data_long[data_long$sample == "DOM11448", ] #low abs
dfs <- data_long[data_long$sample == "DOM11187", ] #
#| data_long$sample == "DOM11575"

loessMod10 <- loess(value ~ wavelength, data=data_long2, span=0.10)





loessMod10 <- loess(value ~ wavelength, data=dfs, span=0.10) # 10% smoothing span
loessMod25 <- loess(value ~ wavelength, data=dfs, span=0.25) # 25% smoothing span
loessMod50 <- loess(value ~ wavelength, data=dfs, span=0.50) # 50% smoothing span

smoothed10 <- predict(loessMod10) 
smoothed25 <- predict(loessMod25) 
smoothed50 <- predict(loessMod50) 

plot(dfs$value, x=dfs$wavelength, type="l", lwd=2, main="Loess Smoothing and Prediction", xlab="Date", ylab="Absobance")
lines(smoothed10, x=dfs$wavelength, col="red", lwd=1)
lines(smoothed25, x=dfs$wavelength, col="green", lwd=1)
lines(smoothed50, x=dfs$wavelength, col="blue", lwd=1)





  
  
  
```



```{r Automate loess smoothing per sample}
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)

models <- data_long2 %>%
        tidyr::nest(-sample) %>%
        dplyr::mutate(
                # Perform loess calculation on each CpG group
                m = purrr::map(data, loess,
                               formula = value ~ wavelength, span = .5),
                # Retrieve the fitted values from each model
                fitted = purrr::map(m, `[[`, "fitted")
        )

# Apply fitted y's as a new column
results <- models %>%
        dplyr::select(-m) %>%
        tidyr::unnest()

# Plot with loess line for each group
ggplot(results, aes(x = wavelength, y = value, group = sample)) +
        geom_point() +
        geom_line(aes(y = fitted))

```

### Blanks and Standards
- Extract blank samples, have visual inspection and calculate LOD/LOQ
- using wavelength 254 nm (X253.5999908)
- have a look at consistency with standard sampels

```{r Blanks and Standard}
absBlanks <- abs[grep("DOMB", abs$sample), ]

ggplot(absBlanks, aes(y= X253.5999908, x=sample)) + 
  geom_bar(stat = "identity")+
  labs(title = "Blank samples", x = "", y = "Absorbance at 254 nm")
  

absStd <- absC[grep("DOMSTD", absC$sample), ]
ggplot(absStd, aes(y= X253.5999908, x=sample)) + 
  geom_bar(stat = "identity")+
  labs(title = "Standard sample (Langtjern)", x = "", y = "Absorbance at 254 nm")

RSD <- (sd(absStd$X253.5999908)/mean(absStd$X253.5999908))*100
RSD
#library(rcellminer)
#getRsd(absStd$X253.5999908)

```
### Merge data with C
- have a look at 254 nm signal for low DOC samples
```{r Megre dataframes}
b1 <- merge(chemcatch, d1, by= "station_id") 
b2 <- merge(b1, SNames, by  = "Station.Code.x")
b3 <- merge(b2, abs, by  = "sample")
```

### Calculate indiced ++
```{r Compute indiced ++}
b4 <- transform(b3, sUVa = ((X254.3999939/X2019_DOC.C)*100))
b5 <- transform(b4, sVISa = ((X410.3999939/X2019_DOC.C)*1000))
b6 <- transform(b5, SAR = (X254.3999939/X410.3999939))
b7 <- transform(b6, E2_E3 = (X254.3999939/X364.7999878))
b8 <- transform(b7, HI = (X284.7999878/X254.3999939))
#spectral slopes
b9 <- transform(b8, A220_254 = (X219.1999969/X254.3999939)) #polarity
b10 <- transform(b9, A250_364 = (X249.5999908/X364.7999878))#size/weight
b11 <- transform(b10, A300_400 = (X300/X400)) #humification
#the following two should also be included, but require curve fitting. See Maeve script.
#S275-295 #photodegradation, Helms et al
```

### Plotting
- looking at the low absorbing samples
```{r Visualise the data}

ggplot(low, aes(y= X2019_DOC.C, x=X253.5999908, colour=as.factor(Region.4)))+  
  geom_point()+
  labs(title = "Low signal Samples", x = "Abs 254 nm", y = "DOC (mg/L)")

ggplot(low, aes(y= X2019_DOC.C, x=sample, fill=as.factor(Region.4)))+  
  geom_bar(stat = "identity")+
  labs(title = "Low signal Samples", x = "", y = "DOC (mg/L)")

low <- subset(b11, X253.5999908 < 0.05)
nrow(low)

```

