---
title: '1000Lakes: UV-Vis abs'
author: "CBG"
date: "6 1 2022"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

# An Exploration of UV-Vis data - "1000 Lakes Study"
All samples from the 1000-lakes survey were analysed for UV-Vis absorbance. Here, corrections are made (dilution, other corrections), LOQ determined from blanks, indices, slope ratios etc. calculated, and explored. 

```{r load required packages, include=FALSE}
Packages <- c("ggplot2", "dplyr", "data.table", "tidyr", "tibble", "purrr")
lapply(Packages, library, character.only = TRUE)

```

### The following datasets will be required
- UV-Vis absorbance data 
- chemistry + catchment data
- sample ID conversion file for the file above
```{r load required data and merge the two, keep all samples}
#blank-corrected data from Rolf, all data, no dilution correction
rdv <- read.table("RDV_UVVis_BlankCorrected6.txt", sep = "\t", header = TRUE)
names(rdv) <- gsub(x = names(rdv), pattern = "X", replacement = "DOM")  

#use ra data to find samples with signal at 254 nm < LOQ
#LOQ at 254nm calculated to 0.016
abs <- read.table("A1000Lakes_all_trans.txt", sep = "\t", header = TRUE)
threshhold <- 0.016  
abst <- subset(abs, abs[, 809] > threshhold)  
toolow <- subset(abs, abs[, 809] < threshhold) 
#print(toolow$sample)
class(toolow$sample)
fac <- toolow$sample
typeof(fac)

#other datasets needed
chemcatch <- read.table("1000 lakes joint 29102021_3.txt", sep = "\t", header = TRUE)
d1 <- read.table("1000 sjøer station id og kode.csv", sep = ";", header = TRUE)
d1$station_id = d1$ï..Station.ID
#abs <- read.table("A1000Lakes_all_trans.txt", sep = "\t", header = TRUE)
SNames <- fread("Provenavn.txt", sep = "\t", header = TRUE, select=c("Prøvenr", "Stasjonskode"))
SNames$Station.Code.x = SNames$Stasjonskode
SNames$sample = SNames$Prøvenr
```
### Corrections that must be made includes
- UV-Vis correction
- column names adjusted for merging
- Mean Absorption values from 700 to 900nm are subtracted from the entire spectrum for each sample to
account for absorption offset (Helms et al., 2008)
-  multiplied by 2 following dilution? DOM12522, DOM13465, DOM13010, DOM13474 + more
```{r UV-Vis correction step, subtracting the mean}
#Seems like this also needs to be done on raw data or else we get negative values?
#Why difficult to perform this correction?? Try on old non-blank corrected data
#Worked just fine for old data
#abs$corr = rowMeans(subset(abs, select = c(X700:X900)))
#absC <- sweep(abs[,c(2:877)], 1, abs$corr, "-")
#absC$sample = abs$sample

#Try again with Rolf data
#need to transpose
rdv2 <- t(rdv)
colnames(rdv2) <- rdv2[1,]
rdv2 <- rdv2[-1, ]
colnames(rdv2) <- paste("X", colnames(rdv2),sep = "_")
rdv3 <- as.data.frame(rdv2)

rdv3$corr = rowMeans(subset(rdv3, select = c(X_700:X_900)))
rdv4 <- sweep(rdv3[,c(2:877)], 1, rdv3$corr, "-")
rdv4$sample = rdv3$sample

df <- tibble::rownames_to_column(rdv4, "sample")
df$Status <- "Ok"
df[df$sample %in% fac,]$Status <- "LOW"

df$sample <- make.unique(as.character(df$sample), sep = "_")
#SNames$Station.Code.x = SNames$Stasjonskode
#SNames$sample = SNames$Prøvenr
```
### Have a look at the spectra and see if possible to smooth
- can this be done for all of the samples or only those with DOC too low
- go from wide to long format for plotting
- smoothing: http://r-statistics.co/Loess-Regression-With-R.html
```{r Viasulise and smooth spectra}
data_long3 <- gather(df, wavelength, value, X_200.7999878:X_900)

data_long3$wavelength<-gsub("X_","",as.character(data_long3$wavelength))
data_long3$wavelength = as.numeric(data_long3$wavelength)
data_long3 <- data_long3[ -c(2) ]
```

```{r Function to set loess span optimal for SSSE}
calcSSE <- function(x){
  loessMod <- try(loess(uempmed ~ index, data=economics, span=x), silent=T)
  res <- try(loessMod$residuals, silent=T)
  if(class(res)!="try-error"){
    if((sum(res, na.rm=T) > 0)){
      sse <- sum(res^2)  
    }
  }else{
    sse <- 99999
  }
  return(sse)
}
```


```{r Automate loess smoothing per sample}
#https://stackoverflow.com/questions/50163106/loess-regression-on-each-group-with-dplyrgroup-by
models <- data_long3 %>%
        tidyr::nest(-sample) %>%
        dplyr::mutate(
                # Perform loess calculation on each CpG group
                m = purrr::map(data, loess,
                               formula = value ~ wavelength, span = .5),
                # Retrieve the fitted values from each model
                fitted = purrr::map(m, `[[`, "fitted")
        )

# Apply fitted y's as a new column
results <- models %>%
        dplyr::select(-m) %>%
        tidyr::unnest()

write.table(results, file = "Lake1000_UVVis_LOESS.txt", sep = "\t",
            row.names = TRUE, col.names = NA)


# Plot with loess line for each group
ggplot(results, aes(x = wavelength, y = value, group = sample)) +
        geom_point() +
        geom_line(aes(y = fitted))

```


```{r Make data ready for Rolf}
#make separate file for fitted and measured
#separate out fitted
fit <- results %>%
  select(sample, wavelength,fitted)

data_wide <- spread(fit, wavelength, fitted)

```


### Blanks and Standards
- Extract blank samples, have visual inspection and calculate LOD/LOQ
- using wavelength 254 nm (X253.5999908)
- have a look at consistency with standard sampels

```{r Blanks and Standard}
absBlanks <- abs[grep("DOMB", abs$sample), ]

ggplot(absBlanks, aes(y= X253.5999908, x=sample)) + 
  geom_bar(stat = "identity")+
  labs(title = "Blank samples", x = "", y = "Absorbance at 254 nm")
  

absStd <- absC[grep("DOMSTD", absC$sample), ]
ggplot(absStd, aes(y= X253.5999908, x=sample)) + 
  geom_bar(stat = "identity")+
  labs(title = "Standard sample (Langtjern)", x = "", y = "Absorbance at 254 nm")

RSD <- (sd(absStd$X253.5999908)/mean(absStd$X253.5999908))*100
RSD
#library(rcellminer)
#getRsd(absStd$X253.5999908)

```
### Merge data with C
- have a look at 254 nm signal for low DOC samples
```{r Megre dataframes}
b1 <- merge(chemcatch, d1, by= "station_id") 
b2 <- merge(b1, SNames, by  = "Station.Code.x")
b3 <- merge(b2, abs, by  = "sample")
```

### Calculate indiced ++
```{r Compute indiced ++}
b4 <- transform(b3, sUVa = ((X254.3999939/X2019_DOC.C)*100))
b5 <- transform(b4, sVISa = ((X410.3999939/X2019_DOC.C)*1000))
b6 <- transform(b5, SAR = (X254.3999939/X410.3999939))
b7 <- transform(b6, E2_E3 = (X254.3999939/X364.7999878))
b8 <- transform(b7, HI = (X284.7999878/X254.3999939))
#spectral slopes
b9 <- transform(b8, A220_254 = (X219.1999969/X254.3999939)) #polarity
b10 <- transform(b9, A250_364 = (X249.5999908/X364.7999878))#size/weight
b11 <- transform(b10, A300_400 = (X300/X400)) #humification
#the following two should also be included, but require curve fitting. See Maeve script.
#S275-295 #photodegradation, Helms et al
```

### Plotting
- looking at the low absorbing samples
```{r Visualise the data}

ggplot(low, aes(y= X2019_DOC.C, x=X253.5999908, colour=as.factor(Region.4)))+  
  geom_point()+
  labs(title = "Low signal Samples", x = "Abs 254 nm", y = "DOC (mg/L)")

ggplot(low, aes(y= X2019_DOC.C, x=sample, fill=as.factor(Region.4)))+  
  geom_bar(stat = "identity")+
  labs(title = "Low signal Samples", x = "", y = "DOC (mg/L)")

low <- subset(b11, X253.5999908 < 0.05)
nrow(low)

```

